name: Template Test

on:
  workflow_call:
    inputs:
      test-matrix:
        description: 'JSON array of test configurations'
        required: true
        type: string
      include-docker-build:
        description: 'Whether to include Docker image build'
        required: false
        default: false
        type: boolean
      include-tests:
        description: 'Whether to include test execution'
        required: false
        default: false
        type: boolean

jobs:
  template-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        config: ${{ fromJson(inputs.test-matrix) }}

    steps:
    - uses: actions/checkout@v3
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        global-json-file: global.json
        
    - name: Install template locally
      run: dotnet new install .
      
    - name: Generate project from template - ${{ matrix.config.name }}
      run: |
        mkdir -p test-projects/${{ matrix.config.name }}
        cd test-projects/${{ matrix.config.name }}
        dotnet new netcorepal-web -n TestProject -F ${{ matrix.config.framework }} -D ${{ matrix.config.database }} -M ${{ matrix.config.messagequeue }}
      
    - name: Remove MyGet source for CI
      run: |
        cd test-projects/${{ matrix.config.name }}/TestProject
        # Remove MyGet source which is blocked in CI
        if [ -f NuGet.config ]; then
          sed -i '/<add key="netcorepal-preview"/d' NuGet.config
        fi
        
    - name: Restore dependencies for generated project
      run: |
        cd test-projects/${{ matrix.config.name }}/TestProject
        # Restore dependencies, but allow missing preview packages
        if ! dotnet restore --ignore-failed-sources; then
          echo "❌ RESTORE FAILED for ${{ matrix.config.name }}"
          exit 1
        fi
        
    - name: Build generated project
      run: |
        cd test-projects/${{ matrix.config.name }}/TestProject
        # Build the project - this must succeed
        if ! dotnet build --no-restore --configuration Release --verbosity minimal; then
          echo "❌ BUILD FAILED for ${{ matrix.config.name }}"
          echo "Build logs:"
          dotnet build --no-restore --configuration Release --verbosity normal
          exit 1
        fi
        echo "✅ BUILD SUCCEEDED for ${{ matrix.config.name }}"
        
    - name: Run tests for generated project
      if: ${{ inputs.include-tests }}
      run: |
        cd test-projects/${{ matrix.config.name }}/TestProject
        # Run tests - this must succeed
        if ! dotnet test --no-build --configuration Release --verbosity normal; then
          echo "❌ TESTS FAILED for ${{ matrix.config.name }}"
          exit 1
        fi  
        echo "✅ TESTS SUCCEEDED for ${{ matrix.config.name }}"
        
    - name: Verify project structure and templates
      run: |
        cd test-projects/${{ matrix.config.name }}/TestProject
        echo "Project structure verification:"
        ls -la src/
        echo "Framework verification in csproj:"
        grep -A 2 -B 2 "TargetFramework" src/TestProject.Web/TestProject.Web.csproj
        echo "Database packages verification:"
        grep -E "(SqlServer|MySql|PostgreSQL)" src/TestProject.Web/TestProject.Web.csproj || echo "Database packages found"
        echo "MQ packages verification:"
        grep -E "(RabbitMQ|Kafka|AzureServiceBus)" src/TestProject.Web/TestProject.Web.csproj || echo "MQ packages found"
        
    - name: Setup Docker Buildx
      if: ${{ inputs.include-docker-build }}
      uses: docker/setup-buildx-action@v3
      
    - name: Verify Dockerfile template substitution
      run: |
        cd test-projects/${{ matrix.config.name }}/TestProject
        echo "Dockerfile framework verification:"
        grep -E "(aspnet|sdk):" src/TestProject.Web/Dockerfile
        
    - name: Build Docker image for generated project
      if: ${{ inputs.include-docker-build }}
      run: |
        cd test-projects/${{ matrix.config.name }}/TestProject
        # Build Docker image - this must succeed for Docker tests
        if ! docker build -f src/TestProject.Web/Dockerfile -t testproject-${{ matrix.config.name }}:latest .; then
          echo "❌ DOCKER BUILD FAILED for ${{ matrix.config.name }}"
          exit 1
        fi
        echo "✅ DOCKER BUILD SUCCEEDED for ${{ matrix.config.name }}"
        
    - name: Uninstall template
      run: dotnet new uninstall .
      if: always()