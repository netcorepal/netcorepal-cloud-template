name: Template Test

on:
  workflow_call:
    inputs:
      include-docker-build:
        description: 'Whether to include Docker image build'
        required: false
        default: false
        type: boolean
      include-tests:
        description: 'Whether to include test execution'
        required: false
        default: false
        type: boolean

jobs:
  template-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      #max-parallel: 2
      matrix:
        framework: [ 'net8.0', 'net9.0', 'net10.0' ]
        database: [ 'MySql', 'SqlServer', 'PostgreSQL' ]
        messagequeue: [ 'RabbitMQ', 'Kafka', 'RedisStreams', 'NATS', 'AzureServiceBus', 'AmazonSQS', 'Pulsar' ]
        aspire: [ 'false', 'true' ]
    name: ${{ matrix.database }}-${{ matrix.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}

    steps:
    - uses: actions/checkout@v3
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        global-json-file: global.json
        
    - name: Install template locally
      run: dotnet new install .
      
    - name: Generate project from template - ${{ matrix.database }}-${{ matrix.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}
      run: |
        mkdir -p test-projects/${{ matrix.database }}-${{ matrix.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}
        cd test-projects/${{ matrix.database }}-${{ matrix.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}
        if [ "${{ matrix.aspire }}" == "true" ]; then
          dotnet new netcorepal-web -n TestProject -F ${{ matrix.framework }} -D ${{ matrix.database }} -M ${{ matrix.messagequeue }} --UseAspire
        else
          dotnet new netcorepal-web -n TestProject -F ${{ matrix.framework }} -D ${{ matrix.database }} -M ${{ matrix.messagequeue }}
        fi
        
    - name: Restore dependencies for generated project
      run: |
        cd test-projects/${{ matrix.database }}-${{ matrix.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}/TestProject
        # Restore dependencies, but allow missing preview packages
        if ! dotnet restore --ignore-failed-sources; then
          echo "❌ RESTORE FAILED for ${{ matrix.database }}-${{ matrix.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}"
          exit 1
        fi
        
    - name: Build generated project
      run: |
        cd test-projects/${{ matrix.database }}-${{ matrix.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}/TestProject
        # Build the project - this must succeed
        if ! dotnet build --no-restore --configuration Release --verbosity minimal; then
          echo "❌ BUILD FAILED for ${{ matrix.database }}-${{ matrix.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}"
          echo "Build logs:"
          dotnet build --no-restore --configuration Release --verbosity normal
          exit 1
        fi
        echo "✅ BUILD SUCCEEDED for ${{ matrix.database }}-${{ matrix.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}"
        
    - name: Run tests for generated project
      if: ${{ inputs.include-tests }}
      run: |
        cd test-projects/${{ matrix.database }}-${{ matrix.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}/TestProject
        # Run tests - this must succeed
        if ! dotnet test --no-build --configuration Release --verbosity normal; then
          echo "❌ TESTS FAILED for ${{ matrix.database }}-${{ matrix.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}"
          exit 1
        fi  
        echo "✅ TESTS SUCCEEDED for ${{ matrix.database }}-${{ matrix.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}"
        
    - name: Verify project structure and templates
      run: |
        cd test-projects/${{ matrix.database }}-${{ matrix.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}/TestProject
        echo "Project structure verification:"
        ls -la src/
        echo "Framework verification in csproj:"
        grep -A 2 -B 2 "TargetFramework" src/TestProject.Web/TestProject.Web.csproj
        echo "Database packages verification:"
        grep -E "(SqlServer|MySql|PostgreSQL)" src/TestProject.Web/TestProject.Web.csproj || echo "Database packages found"
        echo "MQ packages verification:"
        grep -E "(RabbitMQ|Kafka|AzureServiceBus)" src/TestProject.Web/TestProject.Web.csproj || echo "MQ packages found"
        if [ "${{ matrix.aspire }}" == "true" ]; then
          echo "Aspire projects verification:"
          ls -la src/ | grep -E "(AppHost|ServiceDefaults)" || echo "❌ Aspire projects not found"
          if [ -d "src/TestProject.AppHost" ] && [ -d "src/TestProject.ServiceDefaults" ]; then
            echo "✅ Aspire projects found: AppHost and ServiceDefaults"
          else
            echo "❌ Expected Aspire projects not found"
            exit 1
          fi
        else
          echo "Verifying Aspire projects are NOT generated:"
          if [ -d "src/TestProject.AppHost" ] || [ -d "src/TestProject.ServiceDefaults" ]; then
            echo "❌ Aspire projects should not exist when UseAspire is false"
            exit 1
          else
            echo "✅ Aspire projects correctly not generated"
          fi
        fi
        
    - name: Verify solution file format
      run: |
        cd test-projects/${{ matrix.database }}-${{ matrix.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}/TestProject
        echo "Solution file format verification for framework: ${{ matrix.framework }}"
        if [ "${{ matrix.framework }}" == "net8.0" ]; then
          # For net8.0, expect .sln file and no .slnx file
          if [ -f "TestProject.sln" ]; then
            echo "✅ Found TestProject.sln for net8.0"
          else
            echo "❌ TestProject.sln not found for net8.0"
            exit 1
          fi
          if [ -f "TestProject.slnx" ]; then
            echo "❌ TestProject.slnx should not exist for net8.0"
            exit 1
          else
            echo "✅ TestProject.slnx correctly not generated for net8.0"
          fi
        else
          # For net9.0 and net10.0, expect .slnx file and no .sln file
          if [ -f "TestProject.slnx" ]; then
            echo "✅ Found TestProject.slnx for ${{ matrix.framework }}"
          else
            echo "❌ TestProject.slnx not found for ${{ matrix.framework }}"
            exit 1
          fi
          if [ -f "TestProject.sln" ]; then
            echo "❌ TestProject.sln should not exist for ${{ matrix.framework }}"
            exit 1
          else
            echo "✅ TestProject.sln correctly not generated for ${{ matrix.framework }}"
          fi
        fi
        
    - name: Setup Docker Buildx
      if: ${{ inputs.include-docker-build }}
      uses: docker/setup-buildx-action@v3
      
    - name: Verify Dockerfile template substitution
      run: |
        cd test-projects/${{ matrix.database }}-${{ matrix.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}/TestProject
        echo "Dockerfile framework verification:"
        grep -E "(aspnet|sdk):" src/TestProject.Web/Dockerfile
        
    - name: Build Docker image for generated project
      if: ${{ inputs.include-docker-build }}
      run: |
        cd test-projects/${{ matrix.database }}-${{ matrix.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}/TestProject
        # Build Docker image - this must succeed for Docker tests
        CONFIG_NAME="${{ matrix.database }}-${{ matrix.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}"
        IMAGE_TAG="testproject-$(echo "$CONFIG_NAME" | tr '[:upper:]' '[:lower:]'):latest"
        echo "Building Docker image with tag: $IMAGE_TAG"
        if ! docker build -f src/TestProject.Web/Dockerfile -t "$IMAGE_TAG" .; then
          echo "❌ DOCKER BUILD FAILED for $CONFIG_NAME"
          exit 1
        fi
        echo "✅ DOCKER BUILD SUCCEEDED for $CONFIG_NAME"
        
    - name: Uninstall template
      run: dotnet new uninstall .
      if: always()