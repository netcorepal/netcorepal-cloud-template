name: Template Test

on:
  workflow_call:
    inputs:
      include-docker-build:
        description: 'Whether to include Docker image build'
        required: false
        default: false
        type: boolean
      include-tests:
        description: 'Whether to include test execution'
        required: false
        default: false
        type: boolean

jobs:
  template-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        framework: [ 'net10.0', 'net8.0', 'net9.0' ]
        aspire: [ 'true', 'false' ]
        use-admin: [ 'true', 'false' ]
        scenario:
          # Test all databases with RabbitMQ
          - { database: 'MySql', messagequeue: 'RabbitMQ' }
          - { database: 'SqlServer', messagequeue: 'RabbitMQ' }
          - { database: 'PostgreSQL', messagequeue: 'RabbitMQ' }
          - { database: 'Sqlite', messagequeue: 'RabbitMQ' }
          - { database: 'GaussDB', messagequeue: 'RabbitMQ' }
          - { database: 'DMDB', messagequeue: 'RabbitMQ' }
          - { database: 'MongoDB', messagequeue: 'RabbitMQ' }
          
          # Test all message queues with MySql (RabbitMQ already covered above)
          - { database: 'MySql', messagequeue: 'Kafka' }
          - { database: 'MySql', messagequeue: 'RedisStreams' }
          - { database: 'MySql', messagequeue: 'NATS' }
          - { database: 'MySql', messagequeue: 'AzureServiceBus' }
          - { database: 'MySql', messagequeue: 'AmazonSQS' }
    name: ${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}-admin-${{ matrix.use-admin }}

    steps:
    - uses: actions/checkout@v3
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: |
            8.0.x
            9.0.x
            10.0.x
        global-json-file: global.json

    - name: Install SSL Certificates
      run: |
        dotnet dev-certs https --trust

    - name: Install Aspire CLI
      run: |
        curl -sSL https://aspire.dev/install.sh | bash
        echo "export PATH=\"$HOME/.aspire/bin:$PATH\"" >> $GITHUB_ENV

    - name: Validation of Aspire CLI
      run: |
        export PATH="$HOME/.aspire/bin:$PATH"
        aspire --version
        
    - name: Install template locally
      run: dotnet new install .
      
    - name: Generate project from template - ${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}-admin-${{ matrix.use-admin }}
      run: |
        mkdir -p test-projects/${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}-admin-${{ matrix.use-admin }}
        cd test-projects/${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}-admin-${{ matrix.use-admin }}
        if [ "${{ matrix.aspire }}" == "true" ]; then
          dotnet new netcorepal-web -n TestProject -F ${{ matrix.framework }} -D ${{ matrix.scenario.database }} -M ${{ matrix.scenario.messagequeue }} --UseAspire --UseAdmin ${{ matrix.use-admin }}
        else
          dotnet new netcorepal-web -n TestProject -F ${{ matrix.framework }} -D ${{ matrix.scenario.database }} -M ${{ matrix.scenario.messagequeue }} --UseAdmin ${{ matrix.use-admin }}
        fi
        
    - name: Restore dependencies for generated project
      run: |
        cd test-projects/${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}-admin-${{ matrix.use-admin }}/TestProject
        # Restore dependencies, but allow missing preview packages
        if ! dotnet restore --ignore-failed-sources; then
          echo "❌ RESTORE FAILED for ${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}-admin-${{ matrix.use-admin }}"
          exit 1
        fi
        
    - name: Build generated project
      run: |
        cd test-projects/${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}-admin-${{ matrix.use-admin }}/TestProject
        # Build the project - this must succeed
        if ! dotnet build --no-restore --configuration Release --verbosity minimal; then
          echo "❌ BUILD FAILED for ${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}-admin-${{ matrix.use-admin }}"
          echo "Build logs:"
          dotnet build --no-restore --configuration Release --verbosity normal
          exit 1
        fi
        echo "✅ BUILD SUCCEEDED for ${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}-admin-${{ matrix.use-admin }}"
        
    - name: Run tests for generated project
      if: ${{ inputs.include-tests }}
      run: |
        cd test-projects/${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}-admin-${{ matrix.use-admin }}/TestProject
        # Run tests - this must succeed
        if ! dotnet test --no-build --configuration Release \
          --verbosity normal \
          --logger "console;verbosity=normal"; then
          echo "❌ TESTS FAILED for ${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}-admin-${{ matrix.use-admin }}"
          exit 1
        fi  
        echo "✅ TESTS SUCCEEDED for ${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}-admin-${{ matrix.use-admin }}"
        
    - name: Verify project structure and templates
      run: |
        cd test-projects/${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}-admin-${{ matrix.use-admin }}/TestProject
        echo "Project structure verification:"
        ls -la src/
        echo "Framework verification in csproj:"
        grep -A 2 -B 2 "TargetFramework" src/TestProject.Web/TestProject.Web.csproj
        echo "Database packages verification:"
        grep -E "(SqlServer|MySql|PostgreSQL)" src/TestProject.Web/TestProject.Web.csproj || echo "Database packages found"
        echo "MQ packages verification:"
        grep -E "(RabbitMQ|Kafka|AzureServiceBus)" src/TestProject.Web/TestProject.Web.csproj || echo "MQ packages found"
        if [ "${{ matrix.aspire }}" == "true" ]; then
          echo "Aspire projects verification:"
          ls -la src/ | grep -E "(AppHost|ServiceDefaults)" || echo "❌ Aspire projects not found"
          if [ -d "src/TestProject.AppHost" ] && [ -d "src/TestProject.ServiceDefaults" ]; then
            echo "✅ Aspire projects found: AppHost and ServiceDefaults"
          else
            echo "❌ Expected Aspire projects not found"
            exit 1
          fi
        else
          echo "Verifying Aspire projects are NOT generated:"
          if [ -d "src/TestProject.AppHost" ] || [ -d "src/TestProject.ServiceDefaults" ]; then
            echo "❌ Aspire projects should not exist when UseAspire is false"
            exit 1
          else
            echo "✅ Aspire projects correctly not generated"
          fi
        fi
        if [ "${{ matrix.use-admin }}" == "true" ]; then
          echo "Verifying Admin files are present when UseAdmin=true"
          if [ -d "src/TestProject.Domain/AggregatesModel/UserAggregate" ]; then
            echo "✅ UserAggregate found"
          else
            echo "❌ UserAggregate not found when UseAdmin=true"
            exit 1
          fi
          if [ -d "src/TestProject.Domain/AggregatesModel/RoleAggregate" ]; then
            echo "✅ RoleAggregate found"
          else
            echo "❌ RoleAggregate not found when UseAdmin=true"
            exit 1
          fi
          if [ -d "src/TestProject.Domain/AggregatesModel/DeptAggregate" ]; then
            echo "✅ DeptAggregate found"
          else
            echo "❌ DeptAggregate not found when UseAdmin=true"
            exit 1
          fi
          if [ -d "src/TestProject.Web/Endpoints/Identity/Admin" ]; then
            echo "✅ Admin endpoints directory found"
          else
            echo "❌ Admin endpoints directory not found when UseAdmin=true"
            exit 1
          fi
          if [ -d "src/frontend" ]; then
            echo "✅ Frontend directory found"
          else
            echo "❌ Frontend directory not found when UseAdmin=true"
            exit 1
          fi
          if [ -d "src/TestProject.Web/AppPermissions" ]; then
            echo "✅ AppPermissions directory found"
          else
            echo "❌ AppPermissions directory not found when UseAdmin=true"
            exit 1
          fi
        else
          echo "Verifying Admin files are absent when UseAdmin=false"
          if [ -d "src/TestProject.Domain/AggregatesModel/UserAggregate" ]; then
            echo "❌ UserAggregate found when it should be excluded"
            exit 1
          else
            echo "✅ UserAggregate correctly excluded"
          fi
          if [ -d "src/TestProject.Domain/AggregatesModel/RoleAggregate" ]; then
            echo "❌ RoleAggregate found when it should be excluded"
            exit 1
          else
            echo "✅ RoleAggregate correctly excluded"
          fi
          if [ -d "src/TestProject.Domain/AggregatesModel/DeptAggregate" ]; then
            echo "❌ DeptAggregate found when it should be excluded"
            exit 1
          else
            echo "✅ DeptAggregate correctly excluded"
          fi
          if [ -d "src/TestProject.Web/Endpoints/Identity/Admin" ]; then
            echo "❌ Admin endpoints directory found when it should be excluded"
            exit 1
          else
            echo "✅ Admin endpoints directory correctly excluded"
          fi
          if [ -d "src/frontend" ]; then
            echo "❌ Frontend directory found when it should be excluded"
            exit 1
          else
            echo "✅ Frontend directory correctly excluded"
          fi
          if [ -d "src/TestProject.Web/AppPermissions" ]; then
            echo "❌ AppPermissions directory found when it should be excluded"
            exit 1
          else
            echo "✅ AppPermissions directory correctly excluded"
          fi
        fi
        
    - name: Verify solution file format
      run: |
        cd test-projects/${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}-admin-${{ matrix.use-admin }}/TestProject
        echo "Solution file format verification for framework: ${{ matrix.framework }}"
        if [ "${{ matrix.framework }}" == "net8.0" ]; then
          # For net8.0, expect .sln file and no .slnx file
          if [ -f "TestProject.sln" ]; then
            echo "✅ Found TestProject.sln for net8.0"
          else
            echo "❌ TestProject.sln not found for net8.0"
            exit 1
          fi
          if [ -f "TestProject.slnx" ]; then
            echo "❌ TestProject.slnx should not exist for net8.0"
            exit 1
          else
            echo "✅ TestProject.slnx correctly not generated for net8.0"
          fi
        else
          # For net9.0 and net10.0, expect .slnx file and no .sln file
          if [ -f "TestProject.slnx" ]; then
            echo "✅ Found TestProject.slnx for ${{ matrix.framework }}"
          else
            echo "❌ TestProject.slnx not found for ${{ matrix.framework }}"
            exit 1
          fi
          if [ -f "TestProject.sln" ]; then
            echo "❌ TestProject.sln should not exist for ${{ matrix.framework }}"
            exit 1
          else
            echo "✅ TestProject.sln correctly not generated for ${{ matrix.framework }}"
          fi
        fi
        
    - name: Setup Docker Buildx
      if: ${{ inputs.include-docker-build }}
      uses: docker/setup-buildx-action@v3
      
    - name: Verify Dockerfile template substitution
      run: |
        cd test-projects/${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}-admin-${{ matrix.use-admin }}/TestProject
        echo "Dockerfile framework verification:"
        grep -E "(aspnet|sdk):" src/TestProject.Web/Dockerfile
        
    - name: Build Docker image for generated project
      if: ${{ inputs.include-docker-build }}
      run: |
        cd test-projects/${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}-admin-${{ matrix.use-admin }}/TestProject
        # Build Docker image - this must succeed for Docker tests
        CONFIG_NAME="${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}-admin-${{ matrix.use-admin }}"
        IMAGE_TAG="testproject-$(echo "$CONFIG_NAME" | tr '[:upper:]' '[:lower:]'):latest"
        echo "Building Docker image with tag: $IMAGE_TAG"
        if ! docker build -f src/TestProject.Web/Dockerfile -t "$IMAGE_TAG" .; then
          echo "❌ DOCKER BUILD FAILED for $CONFIG_NAME"
          exit 1
        fi
        echo "✅ DOCKER BUILD SUCCEEDED for $CONFIG_NAME"
        
    - name: Uninstall template
      run: dotnet new uninstall .
      if: always()

  template-test-special-names:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        framework: [ 'net9.0', 'net10.0', 'net8.0' ]
        aspire: [ 'true', 'false' ]
        scenario:
          # Test key combinations with special project names
          - { database: 'MySql', messagequeue: 'RabbitMQ' }
          - { database: 'PostgreSQL', messagequeue: 'Kafka' }
          - { database: 'MongoDB', messagequeue: 'NATS' }
    name: SpecialName-${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}

    steps:
    - uses: actions/checkout@v3
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: |
            8.0.x
            9.0.x
            10.0.x
        global-json-file: global.json

    - name: Install SSL Certificates
      run: |
        dotnet dev-certs https --trust

    - name: Install Aspire CLI
      run: |
        curl -sSL https://aspire.dev/install.sh | bash
        echo "export PATH=\"$HOME/.aspire/bin:$PATH\"" >> $GITHUB_ENV

    - name: Validation of Aspire CLI
      run: |
        export PATH="$HOME/.aspire/bin:$PATH"
        aspire --version
        
    - name: Install template locally
      run: dotnet new install .
      
    - name: Generate project from template with special name - ${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}
      run: |
        mkdir -p test-projects/special-${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}
        cd test-projects/special-${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}
        if [ "${{ matrix.aspire }}" == "true" ]; then
          dotnet new netcorepal-web -n My.TestProject -F ${{ matrix.framework }} -D ${{ matrix.scenario.database }} -M ${{ matrix.scenario.messagequeue }} --UseAspire
        else
          dotnet new netcorepal-web -n My.TestProject -F ${{ matrix.framework }} -D ${{ matrix.scenario.database }} -M ${{ matrix.scenario.messagequeue }}
        fi
        
    - name: Restore dependencies for generated project
      run: |
        cd test-projects/special-${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}/My.TestProject
        if ! dotnet restore --ignore-failed-sources; then
          echo "❌ RESTORE FAILED for My.TestProject with ${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}"
          exit 1
        fi
        
    - name: Build generated project
      run: |
        cd test-projects/special-${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}/My.TestProject
        if ! dotnet build --no-restore --configuration Release --verbosity minimal; then
          echo "❌ BUILD FAILED for My.TestProject with ${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}"
          echo "Build logs:"
          dotnet build --no-restore --configuration Release --verbosity normal
          exit 1
        fi
        echo "✅ BUILD SUCCEEDED for My.TestProject with ${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}"
        
    - name: Verify project structure and namespace handling
      run: |
        cd test-projects/special-${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}/My.TestProject
        echo "Project structure verification for special name 'My.TestProject':"
        ls -la src/
        echo "Verifying namespace handling in csproj files:"
        grep -A 2 -B 2 "RootNamespace\|AssemblyName" src/My.TestProject.Web/My.TestProject.Web.csproj || echo "Using default namespace handling"
        echo "Verifying namespace in source files:"
        grep -r "namespace My\.TestProject" src/ | head -5 || echo "Namespace verification complete"
        if [ "${{ matrix.aspire }}" == "true" ]; then
          echo "Aspire projects verification with special name:"
          if [ -d "src/My.TestProject.AppHost" ] && [ -d "src/My.TestProject.ServiceDefaults" ]; then
            echo "✅ Aspire projects found: My.TestProject.AppHost and My.TestProject.ServiceDefaults"
          else
            echo "❌ Expected Aspire projects not found with special name"
            exit 1
          fi
        fi
        
    - name: Verify solution file format with special name
      run: |
        cd test-projects/special-${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}/My.TestProject
        echo "Solution file format verification for framework: ${{ matrix.framework }}"
        if [ "${{ matrix.framework }}" == "net8.0" ]; then
          if [ -f "My.TestProject.sln" ]; then
            echo "✅ Found My.TestProject.sln for net8.0"
          else
            echo "❌ My.TestProject.sln not found for net8.0"
            exit 1
          fi
        else
          if [ -f "My.TestProject.slnx" ]; then
            echo "✅ Found My.TestProject.slnx for ${{ matrix.framework }}"
          else
            echo "❌ My.TestProject.slnx not found for ${{ matrix.framework }}"
            exit 1
          fi
        fi
        
    - name: Verify Dockerfile template substitution with special name
      run: |
        cd test-projects/special-${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}/My.TestProject
        echo "Dockerfile framework verification for special name:"
        grep -E "(aspnet|sdk):" src/My.TestProject.Web/Dockerfile
        echo "Verifying project reference in Dockerfile:"
        grep "My.TestProject.Web.csproj" src/My.TestProject.Web/Dockerfile || echo "Dockerfile content check complete"
        
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker image for project with special name
      run: |
        cd test-projects/special-${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}/My.TestProject
        CONFIG_NAME="${{ matrix.scenario.database }}-${{ matrix.scenario.messagequeue }}-${{ matrix.framework }}-aspire-${{ matrix.aspire }}"
        IMAGE_TAG="my-testproject-$(echo "$CONFIG_NAME" | tr '[:upper:]' '[:lower:]'):latest"
        echo "Building Docker image with tag: $IMAGE_TAG for project with special name"
        if ! docker build -f src/My.TestProject.Web/Dockerfile -t "$IMAGE_TAG" .; then
          echo "❌ DOCKER BUILD FAILED for My.TestProject with $CONFIG_NAME"
          exit 1
        fi
        echo "✅ DOCKER BUILD SUCCEEDED for My.TestProject with $CONFIG_NAME"
        
    - name: Uninstall template
      run: dotnet new uninstall .
      if: always()
  template-test-copilot-instructions:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        framework: [ 'net10.0', 'net9.0' ]
        include-copilot: [ 'true', 'false' ]
    name: CopilotInstructions-${{ matrix.framework }}-include-${{ matrix.include-copilot }}

    steps:
    - uses: actions/checkout@v3
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: |
            8.0.x
            9.0.x
            10.0.x
        global-json-file: global.json

    - name: Install template locally
      run: dotnet new install .
      
    - name: Generate project from template with IncludeCopilotInstructions=${{ matrix.include-copilot }}
      run: |
        mkdir -p test-projects/copilot-test-${{ matrix.framework }}-${{ matrix.include-copilot }}
        cd test-projects/copilot-test-${{ matrix.framework }}-${{ matrix.include-copilot }}
        if [ "${{ matrix.include-copilot }}" == "true" ]; then
          dotnet new netcorepal-web -n CopilotTestProject -F ${{ matrix.framework }} --IncludeCopilotInstructions true
        else
          dotnet new netcorepal-web -n CopilotTestProject -F ${{ matrix.framework }} --IncludeCopilotInstructions false
        fi
        
    - name: Verify .github directory presence/absence
      run: |
        cd test-projects/copilot-test-${{ matrix.framework }}-${{ matrix.include-copilot }}/CopilotTestProject
        if [ "${{ matrix.include-copilot }}" == "true" ]; then
          echo "Verifying .github directory is present when IncludeCopilotInstructions=true"
          if [ -d ".github" ]; then
            echo "✅ .github directory found as expected"
            # Verify copilot-instructions.md exists
            if [ -f ".github/copilot-instructions.md" ]; then
              echo "✅ copilot-instructions.md found"
            else
              echo "❌ copilot-instructions.md not found"
              exit 1
            fi
            # Verify instructions directory exists
            if [ -d ".github/instructions" ]; then
              echo "✅ instructions directory found"
              INSTRUCTION_COUNT=$(find .github/instructions -name "*.instructions.md" | wc -l)
              echo "Found $INSTRUCTION_COUNT instruction files"
              if [ "$INSTRUCTION_COUNT" -gt 0 ]; then
                echo "✅ Instruction files found in .github/instructions"
              else
                echo "❌ No instruction files found in .github/instructions"
                exit 1
              fi
            else
              echo "❌ instructions directory not found"
              exit 1
            fi
          else
            echo "❌ .github directory not found when IncludeCopilotInstructions=true"
            exit 1
          fi
        else
          echo "Verifying .github directory is absent when IncludeCopilotInstructions=false"
          if [ -d ".github" ]; then
            echo "❌ .github directory found when it should be excluded"
            ls -la .github/
            exit 1
          else
            echo "✅ .github directory correctly excluded"
          fi
        fi
        
    - name: Restore dependencies for generated project
      run: |
        cd test-projects/copilot-test-${{ matrix.framework }}-${{ matrix.include-copilot }}/CopilotTestProject
        if ! dotnet restore --ignore-failed-sources; then
          echo "❌ RESTORE FAILED for CopilotTestProject with IncludeCopilotInstructions=${{ matrix.include-copilot }}"
          exit 1
        fi
        
    - name: Build generated project
      run: |
        cd test-projects/copilot-test-${{ matrix.framework }}-${{ matrix.include-copilot }}/CopilotTestProject
        if ! dotnet build --no-restore --configuration Release --verbosity minimal; then
          echo "❌ BUILD FAILED for CopilotTestProject with IncludeCopilotInstructions=${{ matrix.include-copilot }}"
          echo "Build logs:"
          dotnet build --no-restore --configuration Release --verbosity normal
          exit 1
        fi
        echo "✅ BUILD SUCCEEDED for CopilotTestProject with IncludeCopilotInstructions=${{ matrix.include-copilot }}"
        
    - name: Uninstall template
      run: dotnet new uninstall .
      if: always()